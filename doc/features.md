# 功能详解

> 返回 [文档首页](./README.md) · [项目首页](../README.md)

---

### 1. Bot 管理与模板

**Bot 管理** 是系统的核心。每个 Bot 是一个独立的 AI 智能体实体，拥有：

- 独立的身份定义（Identity / Soul / Task 三层人设）
- 独立的容器沙箱（文件系统、命令执行、网络访问）
- 独立的记忆空间（按 bot_id 索引隔离，每个 Bot 的记忆完全独立）
- 独立的频道配置（Telegram / 飞书等）
- 成员权限管理（Owner / Admin / Member 三级角色）
- 生命周期管理（creating → ready → deleting）
- 运行时健康检查（容器初始化、数据路径、任务状态）

**Bot 模板** 是 v2 新增的功能，提供 10 套预设深度人格模板，让创建专业化 Bot 只需两步：

| 步骤 | 操作 |
|------|------|
| **第一步** | 在模板网格中选择一个预设人格（或选"空白 Bot"从零开始） |
| **第二步** | 填写 Bot 名称、类型等基础信息，提交创建 |

系统自动将模板的 Identity（身份）、Soul（灵魂）、Task（任务）内容写入 Bot 的人设配置。

**13 套内置模板：**

| 模板 | 思维模型 | 分类 | 定位 |
|------|----------|------|------|
| CEO 战略顾问 | Jeff Bezos | 商业 | 战略决策、商业模式、优先级排序 |
| CTO 架构师 | Werner Vogels | 开发 | 技术架构、选型决策、可靠性评估 |
| 全栈开发 | DHH | 开发 | 代码实现、技术方案、代码审查 |
| 交互设计 | Alan Cooper | 设计 | 用户流程、Persona 驱动、交互模式 |
| 营销策略 | Seth Godin | 商业 | 产品定位、差异化、增长策略 |
| 运营增长 | Paul Graham | 商业 | 冷启动、用户留存、社区运营 |
| 产品设计 | Don Norman | 设计 | 产品定义、可用性、认知设计 |
| 质量保证 | James Bach | 开发 | 测试策略、风险评估、质量把控 |
| 销售策略 | Aaron Ross | 商业 | 定价策略、销售漏斗、转化优化 |
| UI 设计 | Matías Duarte | 设计 | 视觉设计、设计系统、配色排版 |
| 研究分析师 | — | 效率 | 深度调研、多源验证、结构化输出 |
| 日程秘书 | — | 效率 | 任务管理、日程追踪、承诺跟进 |
| 知识管理师 | — | 效率 | 知识捕获、组织连接、第二大脑 |

其中 10 套来自 [Solo-Company-Skill](https://github.com/anthropics/anthropic-cookbook) 项目的真实思想家思维模型，每个角色包含核心信条、决策框架、独立开发者建议和沟通风格。另外 3 套为通用效率工具角色。

每套模板包含三个 Markdown 文件（`identity.md`、`soul.md`、`task.md`），用中文编写，提取精髓以最大化信息密度、最小化 Token 消耗。

### 2. 对话与流式推送

系统支持两种对话模式：

| 模式 | 说明 | 使用场景 |
|------|------|----------|
| **流式推送 (SSE)** | 服务端逐 token 推送，前端实时渲染 | Web 聊天界面、需要即时反馈的场景 |
| **同步响应** | 等待完整回复后一次性返回 | API 调用、频道消息（Telegram/飞书） |

**对话上下文管理：**

- 最近 24 小时的对话自动加载为短期记忆
- 超出 Token 预算时自动裁剪 + LLM 摘要压缩
- 相关长期记忆通过语义搜索召回
- 对话结束后自动提取关键信息存入长期记忆

### 3. 记忆系统

记忆系统是 Memoh 的核心竞争力，采用三层混合架构：

| 层级 | 技术 | 作用 |
|------|------|------|
| **向量语义搜索** | Qdrant | 通过 Embedding 模型将文本转为向量，按语义相似度检索相关记忆 |
| **BM25 关键词索引** | 内置 | 传统关键词匹配，弥补语义搜索的精确查找不足 |
| **LLM 智能提取** | Chat 模型 | 每轮对话后自动提取关键事实，过滤噪声 |

**记忆生命周期：**

```
对话 → LLM 提取关键信息 → Embedding 向量化 → 存入 Qdrant
                                                    ↓
新对话 → 语义搜索 + BM25 匹配 → 召回相关记忆 → 注入上下文
                                                    ↓
定期维护 → LLM 记忆压缩 → 合并相似项、删除噪声 → 精简记忆库
```

**记忆管理界面** 提供：手动创建记忆、语义搜索、批量删除、记忆压缩（三档力度：轻度/中度/重度）、用量统计。

### 4. 容器系统

每个 Bot 拥有独立的 containerd 容器，提供完全隔离的运行环境：

| 能力 | 说明 |
|------|------|
| **文件读写** | Bot 可在自己的数据目录中创建、读取、修改、删除文件 |
| **命令执行** | Bot 可在容器内执行任意 Shell 命令 |
| **网络访问** | Bot 可访问外部 API 和网站 |
| **浏览器自动化** | 内置 Chromium + xvfb，支持无头浏览器操作 |
| **快照与回滚** | 任意时刻创建快照，可恢复到历史状态 |
| **技能安装** | 通过 ClawHub CLI 一键安装社区技能 |
| **共享目录** | `/shared` 目录跨 Bot 共享 |

**容器内预装能力：**
- **agent-browser** — 浏览器自动化框架
- **Actionbook** — 预编译的网站操作手册，加速常见网站的自动化操作
- **ClawHub CLI** — 技能市场命令行工具
- **OpenViking** — 分层上下文数据库（需开启）

### 5. 频道接入

Bot 通过频道适配器连接外部消息平台。目前实现了 4 种适配器：

| 适配器 | 平台 | 说明 |
|--------|------|------|
| **Telegram** | Telegram | 通过 Bot Token 接入，支持私聊和群聊 |
| **飞书 (Feishu)** | 飞书 / Lark | 通过飞书应用凭证接入 |
| **Web** | 内置 Web 聊天 | 直接在管理界面中对话，无需外部平台 |
| **Local CLI** | 命令行 | 开发调试用，本地命令行直接对话 |

每个 Bot 可同时配置多个频道。频道适配器负责：消息格式转换、身份解析、路由分发、响应投递。

用户可通过 Bind Code（绑定码）将 Telegram / 飞书账号关联到系统用户，实现跨平台身份统一。

### 6. MCP 工具系统

Bot 的能力通过 MCP（Model Context Protocol）工具系统扩展。分为两类：

**内置工具（15 个）** — 每个 Bot 自动拥有，无需配置：

| 类别 | 工具 | 功能 |
|------|------|------|
| 文件操作 | `read` / `write` / `list` / `edit` | 容器内文件读写、目录列表、文本替换 |
| 命令执行 | `exec` | 在容器内执行 Shell 命令 |
| 消息发送 | `send` / `react` | 向频道发消息、添加表情回应 |
| 用户查找 | `lookupChannelUser` | 按平台 ID 查找用户或群组 |
| 记忆搜索 | `searchMemory` | 搜索与当前对话相关的记忆 |
| 网页搜索 | `webSearch` | 通过搜索提供方搜索网页 |
| 定时任务 | `listSchedule` / `getSchedule` / `createSchedule` / `updateSchedule` / `deleteSchedule` | 完整的定时任务管理 |

**外部 MCP 服务器** — 可在管理界面中为每个 Bot 单独添加：

| 传输方式 | 说明 | 示例 |
|----------|------|------|
| **Stdio** | 在容器内启动进程 | `npx @modelcontextprotocol/server-filesystem` |
| **Remote** | 连接远程 HTTP/SSE 服务 | `https://mcp.example.com/sse` |

支持批量导入标准 `mcpServers` JSON 配置。工具网关（Tool Gateway）负责将 Agent Gateway 的工具调用代理到容器内的 MCP 服务器。

### 7. 心跳与定时任务

**心跳 (Heartbeat)** 让 Bot 从被动应答转为主动行动：

- 新建 Bot **自动创建**默认心跳（每小时一次维护检查）
- 支持 **定时触发**（间隔秒数）和 **事件触发**（定时任务完成、收到消息等）
- 触发时向 Bot 发送一条提示词，Bot 自主决定行动
- 可在管理界面添加多个心跳，每个有独立的间隔、提示词和触发条件
- 自我进化系统使用专用心跳（标记为 `[evolution-reflection]`，默认 24 小时间隔）

**定时任务 (Schedule)** 让 Bot 按 Cron 表达式执行周期性工作：

- Bot 可在对话中**自主创建**定时任务（通过内置 schedule 工具）
- 也可通过管理界面或 API 手动创建
- 每个任务有 Cron 表达式、命令提示词、最大执行次数、启用/禁用控制
- 管理界面展示所有任务的状态和执行次数

### 8. 自我进化系统

自我进化是 Memoh 的核心差异化能力。Bot 可以通过对话学习，自动改进自己的人设和行为。

**核心理念：** 进化是有机的 —— 源于真实对话，而非强制调度。如果近期对话顺畅无摩擦，不需要进化。系统只在有实质性学习材料时才触发改变。

**三阶段进化周期：**

| 阶段 | 名称 | 动作 |
|------|------|------|
| **Phase 1** | 反思 (Reflect) | 回顾近期对话，寻找摩擦点（错误回答、用户不满）、亮点（用户满意）、模式（反复出现的话题）、空白（缺失的知识）。如果没有发现有意义的信号，直接报告"无需进化"并结束 |
| **Phase 2** | 实验 (Experiment) | 对每个可行洞察：在 EXPERIMENTS.md 中记录（触发原因、观察、行动、预期效果），然后在对应文件中做小幅、可逆的修改（IDENTITY.md / SOUL.md / TOOLS.md） |
| **Phase 3** | 审查 (Review) | 自愈维护：检查定时任务是否正常运行、蒸馏日常笔记为长期记忆、检查协调文件、上报异常 |

**进化日志追踪：**

每次进化心跳触发时，系统自动创建一条 `evolution_logs` 记录（状态：运行中）。Agent 执行完毕后，系统根据返回内容自动更新状态：
- `completed` — 做了改变
- `skipped` — 无需进化（近期对话顺畅）
- `failed` — 执行出错

管理界面的进化页面展示：
- 开关控制和手动触发按钮
- 实验时间线（解析自 EXPERIMENTS.md）
- 进化历史时间线（来自 evolution_logs，含状态徽章和可展开的 Agent 回复详情）
- 人设文件查看器（IDENTITY.md / SOUL.md / TOOLS.md / EXPERIMENTS.md / NOTES.md）

### 9. 子智能体与技能

**子智能体 (Subagents)** 是 Bot 可以委派任务的专业化工作者：

- Agent 在对话中**自动创建和调度**子智能体（无需手动干预）
- 支持在管理界面预注册模板（名称、描述、技能列表），Agent 会优先使用已注册的定义
- 两种调度模式：**spawn**（后台异步执行）和 **query**（同步等待结果）
- 每个子智能体有独立的对话上下文和工具权限

**技能 (Skills)** 是存储在容器中的 Markdown 文件，为 Bot 提供特定领域的能力扩展：

- 每个技能包含名称、描述和详细指令
- Agent 根据对话上下文自动加载相关技能
- 可通过管理界面手动创建，也可通过 ClawHub（社区技能市场）一键安装
- Bot 自身也可以在对话中安装新技能

### 10. OpenViking 分层上下文数据库

[OpenViking](https://github.com/volcengine/OpenViking) 是集成在 Memoh 中的分层上下文数据库，为 Bot 提供超越平面向量检索的结构化长期记忆。

**为什么需要 OpenViking？**

普通向量记忆是"平面"的 —— 每段记忆平等地存储和检索。但人类记忆是分层的：核心知识（总是需要的）和详细细节（偶尔查阅的）。OpenViking 模仿了这种结构：

| 层级 | 名称 | 说明 | 类比 |
|------|------|------|------|
| **L0** | 摘要层 | 高度压缩的概要信息 | 一本书的目录 |
| **L1** | 知识层 | 结构化知识和关键事实 | 一本书的章节总结 |
| **L2** | 细节层 | 完整的原始内容和细节 | 一本书的完整正文 |

对话时先加载 L0 摘要（极少 Token）了解全貌，再按需加载 L1/L2 的特定部分，大幅减少 Token 消耗。

**启用方式：** 在 Bot 设置页面开启"启用 OpenViking 上下文数据库"开关，系统自动生成 `ov.conf` 并预填 API 信息。

### 11. Token 用量与系统诊断

**Token 用量统计：**

- 每次 LLM 调用（对话、心跳、定时任务、记忆操作）自动记录 Token 消耗
- 管理界面提供 Dashboard：每日用量曲线图 + 多 Bot 横向对比
- 支持查看近 7 天 / 30 天 / 90 天数据

**系统诊断：**

一键检测所有依赖服务的健康状态（PostgreSQL、Qdrant、Agent Gateway、Containerd），快速定位问题。

### 12. 跨 Bot 协作

**共享工作区：** 所有 Bot 容器自动挂载 `/shared` 目录，指向同一宿主机路径。

创建 Bot 时，系统自动在 `/shared/{bot_name}/` 下创建该 Bot 的专属输出文件夹。文件存放约定：

| 路径 | 范围 | 用途 |
|------|------|------|
| `/data/` | 私有 | 系统文件（IDENTITY.md、SOUL.md、TOOLS.md 等） |
| `/shared/{bot_name}/` | 共享 | Bot 的产出文件（报告、分析、草稿等） |
| `/shared/{other_bot}/` | 只读 | 其他 Bot 的产出（可读不可写） |

Bot 之间通过文件进行协调：

```
Agent A 写入报告到 /shared/AgentA/ → Agent B 读取 → Agent B 写入草稿到 /shared/AgentB/
```

协调的本质是文件系统 —— 简单、可靠、无需 API。管理界面提供共享工作区的文件浏览和编辑功能。
