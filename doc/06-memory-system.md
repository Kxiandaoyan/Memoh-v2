# 记忆系统

Memoh 的核心特色之一是为每个 Bot 提供独立的 **结构化长期记忆**。记忆系统基于向量数据库（Qdrant），可以语义搜索相关记忆并注入到对话上下文中。

## 进入记忆管理

Bot 详情页 → **记忆** 标签。

## 页面布局

- **左侧面板**：记忆列表，支持搜索和刷新。
- **右侧面板**：选中记忆后显示内容编辑器。
- **下方图表**：向量可视化区域。

## 浏览记忆

记忆列表按创建时间排序，每条记忆显示内容预览。

### 搜索

在搜索框中输入关键词，可以按记忆内容进行模糊筛选。

### 查看详情

点击某条记忆，右侧面板展示完整内容（Markdown 格式）。

## 编辑记忆

选中记忆后，右侧面板切换为编辑模式：
- 文本区域可直接修改记忆内容。
- 修改后点击 **保存** 按钮提交更改。
- 如需取消修改，点击其他记忆或关闭面板。

## 创建记忆

点击 **新建** 按钮，打开创建对话框：

1. **从对话历史创建**：勾选最近的对话消息，系统会将选中的消息内容提取为记忆。
2. **手动输入**：在文本区域中直接编写记忆内容。
3. 点击确认后，记忆会被向量化并存入数据库。

## 记忆压缩

### 自动压缩

每个 Bot 创建时会自动配置一个 **记忆压缩心跳**，默认每 7 天执行一次。自动压缩的行为：

- 当 Bot 的记忆数量超过 50 条时才会触发压缩。
- 默认使用 0.8 的压缩比例（保留约 80% 的记忆）。
- 压缩过程调用 LLM 对相似记忆进行合并和精简，不是简单删除。
- 压缩直接在后端执行，不会消耗 Bot 的对话 Token。

你可以在 Bot 详情页 → **心跳** 标签中找到标记为 `[memory-compact]` 的心跳，调整间隔或禁用。

### 手动压缩

在 **记忆** 标签页中，点击压缩按钮手动触发：

| 参数 | 说明 |
|------|------|
| 压缩比例 | 可选 0.8、0.5、0.3，数值越小压缩越激进 |
| 衰减日期 | 可选，设置一个日期，早于此日期的记忆权重会降低 |

手动压缩适用于需要更激进压缩（如 0.3）或需要立即执行的场景。

## 删除记忆

选中记忆后，点击 **删除** 按钮并确认即可删除。

## 向量可视化

记忆页面下方提供两种图表：

### Top-K Bucket（柱状图）

展示记忆向量在不同 Top-K 桶中的分布情况，反映记忆的语义密度分布。

### Energy Gradient / CDF（折线图）

累积分布函数曲线，展示记忆向量的能量分布。鼠标悬停可查看具体数值。

这两个图表帮助你直观了解记忆库的质量和分布状态。

## 记忆的工作原理

### 存储阶段

1. 用户发送消息 → Bot 处理对话并生成回复。
2. 回复发送后，系统 **异步** 调用 LLM 从对话中提取关键事实（`llm.Extract()`）。
3. 提取的事实与已有记忆进行去重比对（`llm.Decide()`），决定新增、更新或忽略。
4. 每条记忆生成 BM25 稀疏向量（始终生成，用于关键词搜索）。
5. 如果配置了嵌入模型，还会生成密集向量（用于语义搜索）。
6. 向量和文本一起存入 Qdrant 向量数据库。

### 检索阶段

1. 新对话到来时，系统根据用户消息搜索相关记忆。
2. 搜索方式取决于配置：
   - **BM25 关键词搜索**：基于词频和逆文档频率的经典搜索算法，始终可用。
   - **语义搜索**：通过嵌入模型将查询转为向量，在 Qdrant 中按语义相似度搜索（需配置嵌入模型）。
3. 搜索结果被格式化为系统消息，注入到 Bot 的对话上下文中。

### 维护阶段

1. 系统通过心跳机制每 7 天自动触发一次记忆压缩。
2. 当记忆数量超过阈值（50 条）时，LLM 对相似记忆进行合并和精简。
3. 你也可以随时在 UI 中手动触发更激进的压缩。

这意味着：
- Bot 可以跨对话保持记忆连续性。
- 记忆是结构化的，而非简单的对话历史。
- 你可以手动编辑记忆，纠正或补充 Bot 的认知。
- 记忆库会自动维护，不会无限增长。
